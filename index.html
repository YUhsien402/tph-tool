<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœŸå †ç¯©æ¸¬å‡å‹»åº¦åˆ†æ</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        /* --- Dark Mode æ ¸å¿ƒæ¨£å¼ --- */
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-main: #e0e0e0;
            --text-muted: #a0a0a0;
            --accent-green: #00ff9d;
            --accent-red: #ff4d4d;
            --accent-blue: #00f3ff;
            --accent-purple: #bd00ff;
            --accent-orange: #ff9d00;
            --border-color: #333;
            --input-bg: #2a2a2a;
        }

        body {
            font-family: "Segoe UI", Roboto, "Microsoft JhengHei", sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        h1 {
            text-align: center; font-weight: 300; letter-spacing: 2px;
            color: var(--accent-blue); text-transform: uppercase; margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.3);
        }

        /* è¼¸å…¥å€æ§åˆ¶é¢æ¿ */
        .input-panel {
            background: var(--card-bg); padding: 25px; border-radius: 12px;
            border: 1px solid var(--border-color);
            display: grid; gap: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        /* åƒæ•¸è¨­å®šåˆ— */
        .settings-row {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;
            padding-bottom: 20px; border-bottom: 1px solid #333;
        }

        .setting-group { display: flex; flex-direction: column; gap: 5px; }
        
        .setting-input {
            background: var(--input-bg); border: 1px solid #444; color: #fff;
            padding: 10px; border-radius: 6px; font-size: 16px; font-weight: bold;
            transition: 0.3s;
        }
        .setting-input:focus { outline: none; border-color: var(--accent-blue); background: #000; }

        /* æ•¸æ“šè¼¸å…¥èˆ‡æŒ‰éˆ• */
        .data-section {
            display: grid; grid-template-columns: 1fr auto; gap: 20px; align-items: start;
        }

        label { color: var(--text-muted); font-size: 0.85em; font-weight: bold; letter-spacing: 0.5px; }
        
        textarea {
            width: 100%; height: 80px;
            background: #000; border: 1px solid #444; color: var(--accent-green);
            font-family: monospace; font-size: 16px; padding: 15px;
            border-radius: 6px; box-sizing: border-box; resize: vertical;
        }
        textarea:focus { outline: none; border-color: var(--accent-blue); }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn-group { display: flex; flex-direction: column; gap: 10px; min-width: 180px; }

        button {
            border: none; padding: 0 20px; height: 50px;
            font-weight: bold; font-size: 15px; border-radius: 6px;
            cursor: pointer; transition: 0.3s; width: 100%;
            display: flex; align-items: center; justify-content: center; gap: 8px;
        }
        
        .btn-run {
            background: linear-gradient(135deg, #0062ff, #00f3ff); color: #000;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.2);
        }
        .btn-run:hover { transform: translateY(-2px); box-shadow: 0 0 25px rgba(0, 243, 255, 0.5); }

        .btn-excel {
            background: #2a2a2a; color: var(--accent-green); border: 1px solid var(--accent-green);
        }
        .btn-excel:hover { background: rgba(0, 255, 157, 0.1); }

        /* å„€è¡¨æ¿ä½ˆå±€ */
        .dashboard-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;
            margin-top: 30px; display: none;
        }

        .stat-card {
            background: var(--card-bg); padding: 20px; border-radius: 10px;
            border: 1px solid var(--border-color); text-align: center;
            position: relative; overflow: hidden;
        }
        .stat-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
            background: var(--border-color);
        }
        .card-green::before { background: var(--accent-green); }
        .card-red::before { background: var(--accent-red); }
        .card-blue::before { background: var(--accent-blue); }
        .card-purple::before { background: var(--accent-purple); }

        .stat-label { font-size: 14px; color: var(--text-muted); text-transform: uppercase; }
        .stat-value { font-size: 36px; font-weight: 700; margin: 10px 0; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .stat-sub { font-size: 12px; color: #666; }

        /* çµè«–å€å¡Š */
        .verdict-panel {
            grid-column: span 4; background: #000; border: 2px solid #333;
            padding: 25px; border-radius: 12px; display: flex;
            align-items: center; justify-content: space-between;
        }
        .verdict-left h2 { margin: 0; font-size: 28px; }
        .verdict-left p { margin: 5px 0 0 0; color: var(--text-muted); }
        .verdict-badge {
            font-size: 24px; font-weight: bold; padding: 10px 30px;
            border-radius: 50px; background: #333; color: #fff;
        }
        .pass-glow { border-color: var(--accent-green); box-shadow: 0 0 20px rgba(0, 255, 157, 0.1) inset; }
        .pass-glow h2 { color: var(--accent-green); }
        .pass-glow .verdict-badge { background: var(--accent-green); color: #000; box-shadow: 0 0 15px var(--accent-green); }
        
        .fail-glow { border-color: var(--accent-red); box-shadow: 0 0 20px rgba(255, 77, 77, 0.1) inset; }
        .fail-glow h2 { color: var(--accent-red); }
        .fail-glow .verdict-badge { background: var(--accent-red); color: #fff; box-shadow: 0 0 15px var(--accent-red); }

        .warn-glow { border-color: var(--accent-orange); box-shadow: 0 0 20px rgba(255, 157, 0, 0.1) inset; }
        .warn-glow h2 { color: var(--accent-orange); }
        .warn-glow .verdict-badge { background: var(--accent-orange); color: #000; box-shadow: 0 0 15px var(--accent-orange); }

        /* åœ–è¡¨å€ */
        .charts-container {
            display: grid; grid-template-columns: 1fr 1fr; gap: 20px;
            margin-top: 20px; display: none;
        }
        .chart-box {
            background: var(--card-bg); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 20px; height: 400px;
        }
        .chart-title {
            color: var(--text-main); font-size: 16px; margin-bottom: 15px;
            border-left: 4px solid var(--accent-blue); padding-left: 10px;
        }

        @media (max-width: 900px) {
            .settings-row { grid-template-columns: 1fr; }
            .data-section { grid-template-columns: 1fr; }
            .btn-group { flex-direction: row; }
            .dashboard-grid { grid-template-columns: 1fr 1fr; }
            .verdict-panel { grid-column: span 2; flex-direction: column; text-align: center; gap: 15px; }
            .charts-container { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“Š åœŸå †ç¯©æ¸¬å‡å‹»åº¦åˆ†æ</h1>

    <div class="input-panel">
        <div class="settings-row">
            <div class="setting-group">
                <label>1. ç®¡åˆ¶æ¨™æº– (Target Mean)</label>
                <input type="number" id="limitInput" class="setting-input" value="800" placeholder="800">
            </div>
            <div class="setting-group">
                <label>2. 95% UCL å®¹è¨±ä¸Šé™</label>
                <input type="number" id="uclLimitInput" class="setting-input" value="800" placeholder="800">
            </div>
            <div class="setting-group">
                <label>3. åˆæ ¼æ©Ÿç‡é–€æª» (%)</label>
                <input type="number" id="probLimitInput" class="setting-input" value="90" placeholder="90">
            </div>
        </div>

        <div class="data-section">
            <div class="input-group">
                <label>è¼¸å…¥æ•¸æ“š (å¯æ‰‹å‹•è¼¸å…¥ æˆ– åŒ¯å…¥ Excel)</label>
                <textarea id="dataInput" placeholder="è«‹è¼¸å…¥æ•¸å€¼ (ä»¥é€—è™Ÿæˆ–æ›è¡Œåˆ†éš”)..."></textarea>
            </div>
            
            <div class="btn-group">
                <input type="file" id="excelFile" accept=".xlsx, .xls, .csv" style="display:none" onchange="handleFileSelect(event)">
                
                <button class="btn-excel" onclick="document.getElementById('excelFile').click()">
                    ğŸ“‚ åŒ¯å…¥ Excel
                </button>
                <button class="btn-run" onclick="runAnalysis()">
                    ğŸš€ åŸ·è¡Œé‹ç®—
                </button>
            </div>
        </div>
    </div>

    <div class="dashboard-grid" id="dashboard">
        <div class="verdict-panel" id="verdictPanel">
            <div class="verdict-left">
                <h2 id="verdictTitle">ç­‰å¾…åˆ†æ...</h2>
                <p id="verdictDesc">è«‹è¼¸å…¥æ•¸æ“šä»¥è¨ˆç®—é©—æ”¶é¢¨éšª</p>
            </div>
            <div class="verdict-badge" id="verdictBadge">STATUS</div>
        </div>

        <div class="stat-card card-blue">
            <div class="stat-label">æ¨£æœ¬å¹³å‡ (Mean)</div>
            <div class="stat-value" style="color:var(--accent-blue)" id="valMean">-</div>
            <div class="stat-sub" id="lblMeanTarget">ç›®æ¨™ < 800</div>
        </div>
        
        <div class="stat-card card-purple">
            <div class="stat-label">95% UCL ä¸Šé™å€¼</div>
            <div class="stat-value" style="color:var(--accent-purple)" id="valUCL">-</div>
            <div class="stat-sub" id="lblUCLTarget">å®¹è¨±ä¸Šé™ < 800</div>
        </div>

        <div class="stat-card card-green">
            <div class="stat-label">ç¬¦åˆæ¨™æº–æ©Ÿç‡</div>
            <div class="stat-value" id="valProb">-</div>
            <div class="stat-sub" id="lblProbTarget">ç›®æ¨™: &ge; 90%</div>
        </div>

        <div class="stat-card card-red">
            <div class="stat-label">è®Šç•°ä¿‚æ•¸ (CV)</div>
            <div class="stat-value" id="valCV">-</div>
            <div class="stat-sub">æ¨™æº–: å¿…é ˆ &le; 50%</div>
        </div>
    </div>

    <div class="charts-container" id="chartsArea">
        <div class="chart-box">
            <div class="chart-title">æ¡æ¨£é»åˆ†å¸ƒ (ç´…ç·š:ç®¡åˆ¶æ¨™æº–)</div>
            <canvas id="barChart"></canvas>
        </div>
        <div class="chart-box">
            <div class="chart-title">CDF ç´¯ç©æ©Ÿç‡</div>
            <canvas id="cdfChart"></canvas>
        </div>
    </div>
</div>

<script>
    // --- Excel è™•ç†é‚è¼¯ ---
    function handleFileSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheetName = workbook.SheetNames[0];
            const worksheet = workbook.Sheets[firstSheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            let numbers = [];
            jsonData.forEach(row => {
                row.forEach(cell => {
                    if (typeof cell === 'number') numbers.push(cell);
                });
            });

            if (numbers.length === 0) {
                alert("åœ¨ Excel ä¸­æ‰¾ä¸åˆ°æœ‰æ•ˆçš„æ•¸å­—æ•¸æ“šï¼");
                return;
            }
            document.getElementById('dataInput').value = numbers.join(', ');
            runAnalysis();
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    // --- çµ±è¨ˆåˆ†ææ ¸å¿ƒé‚è¼¯ ---
    Chart.defaults.color = '#a0a0a0';
    Chart.defaults.borderColor = '#333';
    
    function erf(x) {
        var a1 =  0.254829592, a2 = -0.284496736, a3 =  1.421413741;
        var a4 = -1.453152027, a5 =  1.061405429, p  =  0.3275911;
        var sign = (x < 0) ? -1 : 1; x = Math.abs(x);
        var t = 1.0 / (1.0 + p*x);
        var y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t * Math.exp(-x*x);
        return sign * y;
    }
    function normalCDF(x, mean, std) {
        return 0.5 * (1 + erf((x - mean) / (std * Math.sqrt(2))));
    }

    let charts = { bar: null, cdf: null };

    function runAnalysis() {
        const input = document.getElementById('dataInput').value;
        const data = input.split(/[\s,]+/).map(Number).filter(n => !isNaN(n) && n !== 0);
        
        if (data.length < 2) { 
            alert("æ•¸æ“šä¸è¶³ï¼Œè«‹è‡³å°‘è¼¸å…¥ 2 ç­†æ•¸æ“š"); return; 
        }

        // --- è®€å–ä½¿ç”¨è€…è¨­å®šçš„åƒæ•¸ ---
        const limit = parseFloat(document.getElementById('limitInput').value) || 800;
        const uclLimit = parseFloat(document.getElementById('uclLimitInput').value) || 800;
        const probThreshold = parseFloat(document.getElementById('probLimitInput').value) || 90;

        const n = data.length;
        const mean = data.reduce((a,b)=>a+b,0) / n;
        const variance = data.reduce((a,b)=>a+Math.pow(b-mean,2),0) / (n-1);
        const std = Math.sqrt(variance);
        const cv = std / mean;

        let t = n > 30 ? 1.645 : 1.833; 
        const ucl = mean + (t * (std / Math.sqrt(n)));
        
        const prob = normalCDF(limit, mean, std);
        const probPct = (prob * 100).toFixed(1);

        // UI Update
        document.getElementById('dashboard').style.display = 'grid';
        document.getElementById('chartsArea').style.display = 'grid';

        document.getElementById('valMean').innerText = mean.toFixed(0);
        document.getElementById('lblMeanTarget').innerText = `ç›®æ¨™ < ${limit}`;

        document.getElementById('valUCL').innerText = ucl.toFixed(0);
        document.getElementById('lblUCLTarget').innerText = `å®¹è¨±ä¸Šé™ < ${uclLimit}`;
        document.getElementById('valUCL').style.color = ucl > uclLimit ? 'var(--accent-red)' : 'var(--accent-purple)';
        
        const cvElem = document.getElementById('valCV');
        cvElem.innerText = (cv * 100).toFixed(0) + "%";
        cvElem.style.color = cv > 0.5 ? 'var(--accent-red)' : 'var(--accent-green)';

        const probElem = document.getElementById('valProb');
        probElem.innerText = probPct + "%";
        document.getElementById('lblProbTarget').innerText = `ç›®æ¨™: â‰¥ ${probThreshold}%`;
        probElem.style.color = probPct >= probThreshold ? 'var(--accent-green)' : 'var(--accent-red)';

        // --- åˆ¤å®šé‚è¼¯ (å‹•æ…‹) ---
        const vPanel = document.getElementById('verdictPanel');
        const vTitle = document.getElementById('verdictTitle');
        const vDesc = document.getElementById('verdictDesc');
        const vBadge = document.getElementById('verdictBadge');

        vPanel.classList.remove('pass-glow', 'fail-glow', 'warn-glow');

        // 1. å¹³å‡å€¼è¶…æ¨™
        if (mean >= limit) {
            vPanel.classList.add('fail-glow');
            vTitle.innerText = "åˆ¤å®šï¼šä¸åˆæ ¼ (FAIL)";
            vDesc.innerText = `å¹³å‡æ¿ƒåº¦ (${mean.toFixed(0)}) è¶…éç®¡åˆ¶æ¨™æº– (${limit})ï¼Œå¿…é ˆæ•´æ²»ã€‚`;
            vBadge.innerText = "DANGER";
        } 
        // 2. CV éé«˜
        else if (cv > 0.5) {
            vPanel.classList.add('fail-glow');
            vTitle.innerText = "åˆ¤å®šï¼šä¸åˆæ ¼ (å‡å‹»åº¦å·®)";
            vDesc.innerText = `CV ç‚º ${(cv*100).toFixed(0)}% (å¤§æ–¼50%)ï¼ŒåœŸå †æ··åˆä¸å‡ã€‚`;
            vBadge.innerText = "NON-UNIFORM";
        }
        // 3. åˆæ ¼ (å‹•æ…‹é–¾å€¼)
        else if (ucl < uclLimit && probPct >= probThreshold) {
            vPanel.classList.add('pass-glow');
            vTitle.innerText = "é©—æ”¶åˆ¤å®šï¼šåˆæ ¼ (PASS)";
            vDesc.innerText = `UCL ä½æ–¼ ${uclLimit}ï¼Œä¸”ç¬¦åˆæ¨™æº–æ©Ÿç‡é” ${probThreshold}% ä»¥ä¸Šã€‚`;
            vBadge.innerText = "SAFE";
        } 
        // 4. é¢¨éšª
        else {
            vPanel.classList.add('warn-glow');
            vTitle.innerText = "åˆ¤å®šï¼šé¢¨éšª (High Risk)";
            if (ucl >= uclLimit) {
                vDesc.innerText = `95% UCL (${ucl.toFixed(0)}) è¶…éå®¹è¨±ä¸Šé™ (${uclLimit})ï¼Œå…·é©—æ”¶é¢¨éšªã€‚`;
            } else {
                vDesc.innerText = `é›– UCL åˆæ ¼ï¼Œä½†å–®é»è¶…æ¨™è‡´ä¿¡å¿ƒæ°´æº– (${probPct}%) ä¸è¶³ ${probThreshold}%ã€‚`;
            }
            vBadge.innerText = "WARNING";
        }

        drawCharts(data, mean, std, limit, uclLimit, probThreshold);
    }

    function drawCharts(data, mean, std, limit, uclLimit, probThreshold) {
        const ctxBar = document.getElementById('barChart').getContext('2d');
        if (charts.bar) charts.bar.destroy();
        
        charts.bar = new Chart(ctxBar, {
            type: 'bar',
            data: {
                labels: data.map((_, i) => i + 1),
                datasets: [{
                    label: 'æ¿ƒåº¦ mg/kg',
                    data: data,
                    backgroundColor: data.map(v => v > limit ? '#ff4d4d' : '#0062ff'),
                    borderRadius: 4
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line', yMin: limit, yMax: limit, borderColor: '#ff4d4d', borderWidth: 2, borderDash: [6, 4],
                                label: { content: `æ¨™æº– ${limit}`, enabled: true, backgroundColor: '#333', color: '#ff4d4d' }
                            },
                            // è‹¥ UCL Limit èˆ‡ Limit ä¸åŒï¼Œæ‰ç•«é€™æ¢ç´«ç·š
                            ...(uclLimit !== limit ? {
                                line2: {
                                    type: 'line', yMin: uclLimit, yMax: uclLimit, borderColor: '#bd00ff', borderWidth: 1, borderDash: [2, 2],
                                    label: { content: `UCLä¸Šé™ ${uclLimit}`, enabled: true, backgroundColor: '#333', color: '#bd00ff', position: 'end' }
                                }
                            } : {})
                        }
                    }
                },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { color: '#333' } }
                }
            }
        });

        const ctxCdf = document.getElementById('cdfChart').getContext('2d');
        if (charts.cdf) charts.cdf.destroy();

        let points = [];
        const startX = Math.min(...data) - 200;
        const endX = Math.max(...data) + 200;
        for (let x = startX; x <= endX; x += (endX-startX)/50) {
            points.push({ x: x, y: normalCDF(x, mean, std) * 100 });
        }

        charts.cdf = new Chart(ctxCdf, {
            type: 'line',
            data: {
                datasets: [{
                    label: 'ç´¯ç©æ©Ÿç‡ (%)', data: points,
                    borderColor: '#00ff9d', borderWidth: 3, pointRadius: 0,
                    fill: true, backgroundColor: 'rgba(0, 255, 157, 0.1)'
                }]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    annotation: {
                        annotations: {
                            line1: {
                                type: 'line', xMin: limit, xMax: limit, borderColor: '#ff4d4d', borderWidth: 2,
                                label: { content: `æ¨™æº– ${limit}`, enabled: true, position: 'start', backgroundColor: '#333' }
                            },
                            line2: {
                                type: 'line', yMin: probThreshold, yMax: probThreshold, borderColor: '#bd00ff', borderWidth: 1, borderDash: [4, 4],
                                label: { content: `${probThreshold}% ä¿¡å¿ƒç·š`, enabled: true, position: 'end', backgroundColor: '#bd00ff', color: 'white' }
                            }
                        }
                    }
                },
                scales: {
                    x: { type: 'linear', title: { display: true, text: 'æ¿ƒåº¦ (mg/kg)', color: '#666' }, grid: { color: '#333' } },
                    y: { min: 0, max: 105, title: { display: true, text: 'æ©Ÿç‡ (%)', color: '#666' }, grid: { color: '#333' } }
                }
            }
        });
    }
</script>

</body>
</html>
